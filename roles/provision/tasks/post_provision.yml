- name: Remove the stale local ssh known_hosts entry
  ansible.builtin.shell: ssh-keygen -R "{{ ansible_host | default(inventory_hostname) }}" && ssh-keygen -R "{{ inventory_hostname }}"
  delegate_to: localhost
  become: false
  failed_when: false

- name: Clear SSH control sockets
  ansible.builtin.shell: rm -f ~/.ansible/cp/*{{ inventory_hostname }}*
  delegate_to: localhost
  become: false
  failed_when: false

- name: Add new host key to known_hosts
  ansible.builtin.shell: ssh-keyscan -H "{{ ansible_host | default(inventory_hostname) }}" >> ~/.ssh/known_hosts
  delegate_to: localhost
  become: false
  failed_when: false

- name: Reset SSH connection
  ansible.builtin.meta: reset_connection

- name: Wait for system to be fully ready
  ansible.builtin.wait_for_connection:
    connect_timeout: 10
    timeout: 120

- name: Gather facts
  ansible.builtin.setup:

- name: Verify network connectivity
  ansible.builtin.ping:

- name: Install python
  include_role:
    name: python
    tasks_from: install

- name: Install specified packages (Arch)
  community.general.pacman:
    name: "{{ item }}"
    state: present
  loop: "{{ packages }}"
  when: ansible_distribution == 'Archlinux'

- name: Install specified packages (Debian)
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop: "{{ packages }}"
  when: ansible_distribution == 'Debian'
